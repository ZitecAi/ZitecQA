# azure-pipelines.yml
trigger: none

resources:
  pipelines:
    - pipeline: AppDeploy
      project: 'Dev-ops IDSF'
      source: 'ZIDSF - PORTAL - STAGING'
      trigger: true

pool:
  vmImage: 'ubuntu-22.04'  # <- fixa 22.04 para compatibilidade com Playwright 1.27.1

variables:
  - group: NetlifySecrets          # NETLIFY_AUTH_TOKEN, NETLIFY_SITE_ID, SITE_URL
  - group: EmailSecrets            # SMTP_SERVER, SMTP_PORT, SMTP_USER, SMTP_PASS, MAIL_TO, MAIL_FROM
  - name: TEST_CSPROJ
    value: 'PortalIDSFTestes/PortalIDSFTestes.csproj'
  - name: TEST_DIR
    value: 'PortalIDSFTestes'
  - name: ALLURE_RESULTS_DIR
    value: 'allure-results'
  - name: ALLURE_REPORT_DIR
    value: 'allure-report'

steps:
  - checkout: self
    displayName: 'Checkout tests repo'

  - task: UseDotNet@2
    displayName: 'Use .NET 8 SDK'
    inputs:
      packageType: 'sdk'
      version: '8.0.x'

  - task: NodeTool@0
    displayName: 'Use Node 18'
    inputs:
      versionSpec: '18.x'

  # Restore + Build
  - script: |
      set -e
      dotnet --info
      dotnet restore "$(TEST_CSPROJ)"
      dotnet build "$(TEST_CSPROJ)" -c Release --no-restore
    displayName: 'Restore + Build'

  # Instala browsers via script do projeto (alinhado à versão do pacote 1.27.1)
  - script: |
      set -e
      cd "$(TEST_DIR)"

      SCRIPT_PATH="$(find ./bin -type f -name 'playwright.ps1' | head -n 1 || true)"
      if [ -z "$SCRIPT_PATH" ]; then
        echo "ERRO: playwright.ps1 não encontrado após o build."
        ls -R ./bin || true
        exit 1
      fi
      echo "Usando script: $SCRIPT_PATH"

      # Tenta com --with-deps (22.04 ok). Se falhar, tenta sem deps.
      if ! pwsh "$SCRIPT_PATH" install --with-deps; then
        echo "Aviso: --with-deps falhou. Tentando 'install' sem deps..."
        pwsh "$SCRIPT_PATH" install
      fi
    displayName: 'Playwright browsers install (project script)'

  # Testes
  - script: |
      set -e
      echo "Rodando testes em: $(TEST_CSPROJ)"
      dotnet test "$(TEST_CSPROJ)" -c Release --logger "trx"
    displayName: 'Run tests'

  # Allure
  - script: |
      set -e
      npm i -g allure-commandline netlify-cli

      RESULTS_FROM=$(find "$(TEST_DIR)/bin/Release" -type d -name "$(ALLURE_RESULTS_DIR)" | head -n 1 || true)
      if [ -n "$RESULTS_FROM" ] && [ ! -d "$(ALLURE_RESULTS_DIR)" ]; then
        cp -r "$RESULTS_FROM" "./$(ALLURE_RESULTS_DIR)"
      fi

      if [ ! -d "$(ALLURE_RESULTS_DIR)" ]; then
        echo "ERROR: pasta '$(ALLURE_RESULTS_DIR)' não encontrada. Configure o adapter Allure para emitir nessa pasta."
        exit 1
      fi

      allure generate --clean -o "$(ALLURE_REPORT_DIR)" "$(ALLURE_RESULTS_DIR)"
    displayName: 'Generate Allure report'

  # Netlify
  - script: |
      set -e
      netlify deploy \
        --prod \
        --dir="$(ALLURE_REPORT_DIR)" \
        --site "$(NETLIFY_SITE_ID)" \
        --auth "$(NETLIFY_AUTH_TOKEN)" \
        --json > deploy.json

      echo "======== Netlify Deploy Result ========"
      cat deploy.json || true
    displayName: 'Deploy to Netlify (prod)'

  # E-mail
  - task: PowerShell@2
    displayName: 'Send email with report link'
    inputs:
      targetType: 'inline'
      script: |
        $siteUrl   = "$(SITE_URL)"
        $smtpHost  = "$(SMTP_SERVER)"
        $smtpPort  = [int]"$(SMTP_PORT)"
        $smtpUser  = "$(SMTP_USER)"
        $smtpPass  = "$(SMTP_PASS)"
        $mailFrom  = "$(MAIL_FROM)"
        $mailTo    = "$(MAIL_TO)"

        $subject = "Allure - Execução $(Build.BuildNumber)"
        $body = "Olá, time!`n`nO relatório Allure da execução $(Build.BuildNumber) está disponível em:`n$siteUrl`n`nPipeline: $(Build.DefinitionName)`nExecução: $(Build.BuildId)"

        if ($smtpUser -and $smtpPass) {
          $sec = ConvertTo-SecureString $smtpPass -AsPlainText -Force
          $cred = New-Object System.Management.Automation.PSCredential($smtpUser, $sec)
          Send-MailMessage -From $mailFrom -To $mailTo -Subject $subject -Body $body -SmtpServer $smtpHost -Port $smtpPort -UseSsl -Credential $cred
        } else {
          Send-MailMessage -From $mailFrom -To $mailTo -Subject $subject -Body $body -SmtpServer $smtpHost -Port $smtpPort
        }

  - task: PublishTestResults@2
    displayName: 'Publish TRX'
    inputs:
      testResultsFormat: 'VSTest'
      testResultsFiles: '**/*.trx'
      failTaskOnFailedTests: true
