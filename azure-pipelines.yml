# azure-pipelines.yml
trigger: none

pool:
  name: zportal-idsf-hmg
  demands:
  - msbuild
  - visualstudio

resources:
  pipelines:
    - pipeline: AppDeploy
      project: 'Dev-ops IDSF'
      source: 'Portal-IDSF-Staging'
      trigger: true

variables:
  - group: NetlifySecrets          # NETLIFY_AUTH_TOKEN, NETLIFY_SITE_ID, SITE_URL (opcional)
  - group: EmailSecrets            # SMTP_SERVER, SMTP_PORT, SMTP_USER, SMTP_PASS, MAIL_TO, MAIL_FROM
  - name: TEST_CSPROJ
    value: 'PortalIDSFTestes/PortalIDSFTestes.csproj'
  - name: TEST_DIR
    value: 'PortalIDSFTestes'
  - name: ALLURE_RESULTS_DIR
    value: 'allure-results'
  - name: ALLURE_REPORT_DIR
    value: 'allure-report'

jobs:
# ========================= JOB 1 — TESTS =========================
- job: Tests
  displayName: "Run Playwright/NUnit tests"
  pool: { vmImage: 'ubuntu-22.04' }

  steps:
  - checkout: self

  - task: UseDotNet@2
    inputs: { packageType: 'sdk', version: '8.0.x' }

  - task: NodeTool@0
    inputs: { versionSpec: '18.x' }

  - script: |
      set -e
      dotnet clean "$(TEST_CSPROJ)" -c Release
      rm -rf "$(TEST_DIR)/bin" \
             "$(TEST_DIR)/obj" \
             "$(Build.SourcesDirectory)/TestResults" \
             "$(Build.SourcesDirectory)/_allure" \
             "$(Build.SourcesDirectory)/$(ALLURE_REPORT_DIR)"
      find "$(Build.SourcesDirectory)" -type d -name "$(ALLURE_RESULTS_DIR)" -prune -exec rm -rf {} +
      mkdir -p "$(Build.SourcesDirectory)/_allure/results"
      cat > "$(Build.SourcesDirectory)/allure.config.json" <<EOF
      { "allure": { "directory": "$(Build.SourcesDirectory)/_allure/results" } }
      EOF
    displayName: 'Clean + configurar Allure (fresh)'

  - script: |
      set -e
      dotnet --info
      dotnet restore "$(TEST_CSPROJ)"
      dotnet build   "$(TEST_CSPROJ)" -c Release --no-restore
    displayName: 'Restore + Build'

  - script: |
      set -e
      cd "$(TEST_DIR)"
      SCRIPT_PATH="$(find ./bin -type f -name 'playwright.ps1' | head -n 1 || true)"
      if [ -z "$SCRIPT_PATH" ]; then
        echo "ERRO: playwright.ps1 não encontrado."
        ls -R ./bin || true
        exit 1
      fi
      pwsh "$SCRIPT_PATH" install --with-deps || pwsh "$SCRIPT_PATH" install
    displayName: 'Playwright browsers install'

  - script: |
      set +e
      echo "Rodando testes em: $(TEST_CSPROJ)"
      dotnet test "$(TEST_CSPROJ)" -c Release \
        -l "console;verbosity=detailed" \
        --logger "trx;LogFileName=$(Build.SourcesDirectory)/TestResults/results.trx"
      TEST_EXIT=$?
      echo "##vso[task.setvariable variable=TEST_EXIT;isOutput=true]$TEST_EXIT"
      exit 0
    name: runTests
    displayName: 'Run tests (non-blocking)'
    env:
      ALLURE_CONFIG: $(Build.SourcesDirectory)/allure.config.json
      ALLURE_RESULTS_DIRECTORY: $(Build.SourcesDirectory)/_allure/results

  - task: PublishTestResults@2
    inputs:
      testResultsFormat: VSTest
      testResultsFiles: 'TestResults/**/*.trx'
      searchFolder: '$(Build.SourcesDirectory)'
      failTaskOnFailedTests: false
      testRunTitle: 'NUnit TRX'
      mergeTestResults: true
    displayName: 'Publish TRX'

  # Sanity obrigatório: falha se não houver JSONs do Allure
  - script: |
      set -e
      DIR="$(Build.SourcesDirectory)/_allure/results"
      echo "Sanity em $DIR"
      ls -la "$DIR" || true
      COUNT=$(find "$DIR" -maxdepth 1 -type f -name '*.json' | wc -l | xargs)
      echo "Arquivos Allure: $COUNT"
      if [ "$COUNT" -eq 0 ]; then
        echo "ERRO: Nenhum JSON do Allure gerado. Verifique pacotes Allure.NUnit/Allure.Commons e variáveis ALLURE_CONFIG/ALLURE_RESULTS_DIRECTORY."
        exit 1
      fi
    displayName: 'Sanity: validar _allure/results'

  - task: PublishPipelineArtifact@1
    inputs:
      artifact: 'allure-results'
      targetPath: '$(Build.SourcesDirectory)/_allure/results'
    displayName: 'Publish artifact: allure-results'

# ========================= JOB 2 — REPORT =========================
- job: Report
  displayName: "Generate Allure + Deploy Netlify + E-mail"
  pool: { vmImage: 'ubuntu-22.04' }
  dependsOn: Tests
  condition: always()

  variables:
    TEST_EXIT_FROM_PREV: $[ dependencies.Tests.outputs['runTests.TEST_EXIT'] ]

  steps:
  - download: current
    artifact: 'allure-results'
    displayName: 'Download artifact: allure-results'

  - task: NodeTool@0
    inputs: { versionSpec: '18.x' }
    displayName: 'Use Node 18'

  - script: |
      set -e
      SRC="$(Pipeline.Workspace)/allure-results"
      rm -rf "$(ALLURE_REPORT_DIR)"
      mkdir -p "$(ALLURE_REPORT_DIR)"

      echo "Listando SRC=$SRC"
      find "$SRC" -maxdepth 1 -type f -name '*.json' -printf '%f\n' | head || true

      # Gera e remove history para evitar datas “travadas”
      npx -y allure-commandline@2.29.0 generate --clean -o "$(ALLURE_REPORT_DIR)" "$SRC"
      rm -rf "$(ALLURE_REPORT_DIR)/history" || true
      touch "$(ALLURE_REPORT_DIR)/.nojekyll"
      test -f "$(ALLURE_REPORT_DIR)/index.html"
    displayName: 'Generate Allure report (fresh)'

  - script: |
      set -e
      npm i -g netlify-cli
      netlify --version

      netlify deploy \
        --prod \
        --dir="$(ALLURE_REPORT_DIR)" \
        --site "$(NETLIFY_SITE_ID)" \
        --auth "$(NETLIFY_AUTH_TOKEN)" \
        --message "Allure $(Build.BuildNumber)" \
        --json > deploy.json

      cat deploy.json
      URL=$(node -e "let d='';process.stdin.on('data',c=>d+=c).on('end',()=>{let j=JSON.parse(d);console.log(j.url||j.deploy_url||'')})" < deploy.json)
      echo "##vso[task.setvariable variable=NETLIFY_URL]$URL"
    displayName: 'Deploy to Netlify (prod)'

  - task: PowerShell@2
    condition: always()
    env:
      SITE_URL: $(NETLIFY_URL)
      SMTP_SERVER: $(SMTP_SERVER)
      SMTP_PORT: $(SMTP_PORT)
      SMTP_USER: $(SMTP_USER)
      SMTP_PASS: $(SMTP_PASS)
      MAIL_FROM: $(MAIL_FROM)
      MAIL_TO: $(MAIL_TO)
      TEST_EXIT: $(TEST_EXIT_FROM_PREV)
      BUILD_DEFINITIONNAME: $(Build.DefinitionName)
      BUILD_BUILDID: $(Build.BuildId)
      BUILD_BUILDNUMBER: $(Build.BuildNumber)
    inputs:
      targetType: inline
      script: |
        $siteUrl = $env:SITE_URL
        $pipeline = $env:BUILD_DEFINITIONNAME
        $buildId  = $env:BUILD_BUILDID
        $buildNum = $env:BUILD_BUILDNUMBER
        $testExit = $env:TEST_EXIT
        if ($testExit -ne "0") { $status = "COM FALHAS" } else { $status = "SUCESSO" }
        $subject = "Relatório Allure (Staging) - $status"
        $body = "Pipeline: $pipeline`nExecução: $buildNum (ID $buildId)`nStatus dos testes: $status (exit $testExit)`nRelatório: $siteUrl"
        if ($env:SMTP_USER -and $env:SMTP_PASS) {
          $sec  = ConvertTo-SecureString $env:SMTP_PASS -AsPlainText -Force
          $cred = New-Object System.Management.Automation.PSCredential($env:SMTP_USER, $sec)
          Send-MailMessage -From $env:MAIL_FROM -To $env:MAIL_TO -Subject $subject -Body $body -SmtpServer $env:SMTP_SERVER -Port ([int]$env:SMTP_PORT) -UseSsl -Credential $cred -Encoding UTF8
        } else {
          Send-MailMessage -From $env:MAIL_FROM -To $env:MAIL_TO -Subject $subject -Body $body -SmtpServer $env:SMTP_SERVER -Port ([int]$env:SMTP_PORT) -Encoding UTF8
        }
    displayName: 'Send email with report link'
