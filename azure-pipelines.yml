# azure-pipelines.yml  (TESTES E2E pós-deploy - somente projeto PortalIDSFTestes)
name: E2E-Apos-Deploy-$(Date:yyyyMMdd)$(Rev:.r)
trigger: none

resources:
  pipelines:
    - pipeline: appDeploy
      source: 'ZIDSF - PORTAL - DEV'
      branch: 'Dev'
      trigger: true

pool:
  vmImage: 'windows-latest'   # ou 'windows-2022' para fixar

variables:
  BuildConfiguration: 'Release'
  TestResultsDir: '$(System.DefaultWorkingDirectory)\TestResults'
  TestProject: 'ZitecQA\PortalIDSFTestes\PortalIDSFTestes.csproj'
  EmailTo: 'al@zitec.ai'
  EmailFrom: 'no-reply@zitec.ai'
  SmtpHost: 'smtp.office365.com'
  SmtpPort: '587'

stages:
- stage: e2e_tests
  displayName: 'E2E após Deploy'
  condition: succeeded()
  jobs:
  - job: run_e2e
    displayName: 'Rodar NUnit + Playwright (somente PortalIDSFTestes)'
    steps:
    - checkout: self
      fetchDepth: 0

    - task: UseDotNet@2
      displayName: 'Instalar .NET SDK 8.x'
      inputs:
        packageType: 'sdk'
        version: '8.x'

    # Restore somente PortalIDSFTestes
    - script: dotnet restore "$(TestProject)"
      displayName: 'Restore (somente PortalIDSFTestes)'

    # Build somente PortalIDSFTestes
    - script: dotnet build "$(TestProject)" --configuration $(BuildConfiguration) --no-restore
      displayName: 'Build (somente PortalIDSFTestes)'

    # Instalar Playwright CLI e browsers (Windows)
    - powershell: |
        dotnet tool install --global Microsoft.Playwright.CLI
        Write-Host "##vso[task.prependpath]$env:USERPROFILE\.dotnet\tools"
        playwright install
      displayName: 'Instalar Playwright browsers (Windows)'

    # Executar testes somente no PortalIDSFTestes
    - script: |
        mkdir "$(TestResultsDir)" 2>nul || exit /b 0
        dotnet test "$(TestProject)" --configuration $(BuildConfiguration) ^
          --logger "trx;LogFileName=e2e.trx" ^
          --results-directory "$(TestResultsDir)" ^
          --no-build
      displayName: 'Executar testes E2E (PortalIDSFTestes)'

    # Publicar TRX na aba Tests
    - task: PublishTestResults@2
      displayName: 'Publicar Test Results (TRX)'
      inputs:
        testResultsFormat: 'VSTest'
        testResultsFiles: '$(TestResultsDir)\**\*.trx'
        failTaskOnFailedTests: true
        testRunTitle: 'E2E após deploy'

    # Artefatos
    - task: PublishBuildArtifacts@1
      displayName: 'Publicar artefatos (TRX, traces)'
      inputs:
        PathtoPublish: '$(System.DefaultWorkingDirectory)'
        ArtifactName: 'e2e-artifacts'
        publishLocation: 'Container'

    # E-mail com links
    - task: PowerShell@2
      displayName: 'Enviar e-mail com links do job'
      inputs:
        targetType: 'inline'
        script: |
          $buildUrl = "$(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)"
          $testsTab = "$buildUrl&_a=summary"
          $subject = "[E2E] Pós-deploy - $(Build.SourceBranchName) #$(Build.BuildId) - $(Agent.JobStatus)"
          $body = @"
          <div style='font-family:Segoe UI,Arial,sans-serif'>
            <h2>Automação E2E executada após deploy</h2>
            <p><b>Status do job:</b> $(Agent.JobStatus)</p>
            <ul>
              <li><b>Resumo/Tests:</b> <a href='$testsTab'>$testsTab</a></li>
              <li><b>Job completo:</b> <a href='$buildUrl'>$buildUrl</a></li>
            </ul>
          </div>
          "@
          $secure = ConvertTo-SecureString "$(SmtpPass)" -AsPlainText -Force
          $cred = New-Object System.Management.Automation.PSCredential("$(SmtpUser)", $secure)
          Send-MailMessage -From '$(EmailFrom)' -To '$(EmailTo)' -Subject $subject -Body $body -BodyAsHtml -SmtpServer '$(SmtpHost)' -Port $(SmtpPort) -UseSsl -Credential $cred
