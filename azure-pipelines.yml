# azure-pipelines.yml  (pipeline de TESTES E2E)
name: E2E-Apos-Deploy-$(Date:yyyyMMdd)$(Rev:.r)

trigger: none

resources:
  pipelines:
    - pipeline: appDeploy
      source: 'ZIDSF - PORTAL - DEV'   # nome EXATO do pipeline de deploy
      branch: 'Dev'
      trigger: true

pool:
  vmImage: 'ubuntu-latest'

variables:
  BuildConfiguration: 'Release'
  TestResultsDir: '$(System.DefaultWorkingDirectory)/TestResults'
  EmailTo: 'devs@empresa.com'
  EmailFrom: 'qa-bot@empresa.com'
  SmtpHost: 'smtp.office365.com'
  SmtpPort: '587'

stages:
- stage: e2e_tests
  displayName: 'E2E após Deploy (ZIDSF - PORTAL - DEV)'
  condition: succeeded()
  jobs:
  - job: run_e2e
    displayName: 'Rodar NUnit + Playwright e publicar resultados'
    steps:
    - checkout: self
      fetchDepth: 0

    - task: UseDotNet@2
      displayName: 'Instalar .NET SDK 8.x'
      inputs:
        packageType: 'sdk'
        version: '8.x'

    # 1) Restore
    - script: dotnet restore
      displayName: 'Restore'

    # 2) Build
    - script: dotnet build --configuration $(BuildConfiguration) --no-restore
      displayName: 'Build'

    # 3) Instalar Playwright CLI e browsers (depois do build)
    - script: |
        dotnet tool install --global Microsoft.Playwright.CLI
        export PATH="$PATH:$HOME/.dotnet/tools"
        playwright install --with-deps
      displayName: 'Instalar Playwright browsers'

    # 4) Testes
    - script: |
        mkdir -p "$(TestResultsDir)"
        dotnet test --configuration $(BuildConfiguration) \
          --logger "trx;LogFileName=e2e.trx" \
          --results-directory "$(TestResultsDir)" \
          --no-build
      displayName: 'Executar testes E2E (NUnit + Playwright)'

    # Publicar TRX na aba Tests
    - task: PublishTestResults@2
      displayName: 'Publicar Test Results (TRX)'
      inputs:
        testResultsFormat: 'VSTest'
        testResultsFiles: '$(TestResultsDir)/**/*.trx'
        failTaskOnFailedTests: true
        testRunTitle: 'E2E após deploy'

    # Artefatos (TRX, traces, etc.)
    - task: PublishBuildArtifacts@1
      displayName: 'Publicar artefatos (TRX, traces)'
      inputs:
        PathtoPublish: '$(System.DefaultWorkingDirectory)'
        ArtifactName: 'e2e-artifacts'
        publishLocation: 'Container'

    # E-mail com links
    - task: PowerShell@2
      displayName: 'Enviar e-mail com links do job'
      inputs:
        targetType: 'inline'
        script: |
          $buildUrl = "$(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)"
          $testsTab = "$buildUrl&_a=summary"
          $subject = "[E2E] Pós-deploy - $(Build.SourceBranchName) #$(Build.BuildId) - $(Agent.JobStatus)"

          $body = @"
          <div style='font-family:Segoe UI,Arial,sans-serif'>
            <h2>Automação E2E executada após deploy</h2>
            <p><b>Status do job:</b> $(Agent.JobStatus)</p>
            <ul>
              <li><b>Resumo/Tests:</b> <a href='$testsTab'>$testsTab</a></li>
              <li><b>Job completo:</b> <a href='$buildUrl'>$buildUrl</a></li>
            </ul>
            <p>Artefatos (TRX, traces) disponíveis neste job.</p>
          </div>
          "@

          $secure = ConvertTo-SecureString "$(SmtpPass)" -AsPlainText -Force
          $cred = New-Object System.Management.Automation.PSCredential("$(SmtpUser)", $secure)

          Send-MailMessage `
            -From '$(EmailFrom)' `
            -To '$(EmailTo)' `
            -Subject $subject `
            -Body $body `
            -BodyAsHtml `
            -SmtpServer '$(SmtpHost)' `
            -Port $(SmtpPort) `
            -UseSsl `
            -Credential $cred
