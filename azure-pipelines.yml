# azure-pipelines.yml  (TESTES E2E pós-deploy - somente projeto PortalIDSFTestes)
name: E2E-Apos-Deploy-$(Date:yyyyMMdd)$(Rev:.r)
trigger: none

resources:
  pipelines:
    - pipeline: appDeploy
      source: 'ZIDSF - PORTAL - DEV'
      branch: 'Dev'
      trigger: true

pool:
  vmImage: 'windows-latest'   # ou 'windows-2022' para fixar

variables:
  BuildConfiguration: 'Release'
  TestResultsDir: '$(System.DefaultWorkingDirectory)\TestResults'
  TestProject: 'PortalIDSFTestes\PortalIDSFTestes.csproj'
  EmailTo: 'al@zitec.ai'
  EmailFrom: 'no-reply@zitec.ai'     # remetente desejado (mailbox/alias com Send As concedido)
  SmtpHost: 'smtp.office365.com'
  SmtpPort: '587'
  # SmtpUser e SmtpPass devem ser definidos como variáveis secretas no pipeline (ex.: qa-bot@zitec.ai)

stages:
- stage: e2e_tests
  displayName: 'E2E após Deploy'
  condition: succeeded()
  jobs:
  - job: run_e2e
    displayName: 'Rodar NUnit + Playwright (somente PortalIDSFTestes)'
    steps:
    - checkout: self
      fetchDepth: 0

    - task: UseDotNet@2
      displayName: 'Instalar .NET SDK 8.x'
      inputs:
        packageType: 'sdk'
        version: '8.x'

    - script: dotnet restore "$(TestProject)"
      displayName: 'Restore (somente PortalIDSFTestes)'

    - script: dotnet build "$(TestProject)" --configuration $(BuildConfiguration) --no-restore
      displayName: 'Build (somente PortalIDSFTestes)'

    - powershell: |
        dotnet tool update --global Microsoft.Playwright.CLI 2>$null; if ($LASTEXITCODE -ne 0) { dotnet tool install --global Microsoft.Playwright.CLI }
        Write-Host "##vso[task.prependpath]$env:USERPROFILE\.dotnet\tools"
        playwright install
      displayName: 'Instalar Playwright browsers (Windows)'

    - script: |
        mkdir "$(TestResultsDir)" 2>nul || exit /b 0
        dotnet test "$(TestProject)" --configuration $(BuildConfiguration) ^
          --logger "trx;LogFileName=e2e.trx" ^
          --results-directory "$(TestResultsDir)" ^
          --no-build
      displayName: 'Executar testes E2E (PortalIDSFTestes)'

    - task: PublishTestResults@2
      condition: always()
      displayName: 'Publicar Test Results (TRX)'
      inputs:
        testResultsFormat: 'VSTest'
        testResultsFiles: '$(TestResultsDir)\**\*.trx'
        mergeTestResults: true
        failTaskOnFailedTests: true
        testRunTitle: 'E2E após deploy'

    - task: PublishBuildArtifacts@1
      condition: always()
      displayName: 'Publicar artefatos (TRX, traces)'
      inputs:
        PathtoPublish: '$(System.DefaultWorkingDirectory)'
        ArtifactName: 'e2e-artifacts'
        publishLocation: 'Container'

    - task: PowerShell@2
      condition: always()
      displayName: 'Enviar e-mail com links do job'
      inputs:
        targetType: 'inline'
        script: |
          $from = '$(EmailFrom)'   # no-reply@zitec.ai
          $user = '$(SmtpUser)'    # ex.: qa-bot@zitec.ai (com Send As sobre no-reply)
          if ($from -notmatch '^[^@\s]+@[^@\s]+\.[^@\s]+$') { throw "EmailFrom inválido: '$from'" }
          if ($user -notmatch '^[^@\s]+@[^@\s]+\.[^@\s]+$') { throw "SmtpUser inválido (precisa ser e-mail)." }

          $buildUrl = "$(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)"
          $testsTab = "$buildUrl&_a=summary"
          $subject = "[E2E] Pós-deploy - $(Build.SourceBranchName) #$(Build.BuildId) - $(Agent.JobStatus)"
          $body = @"
          <div style='font-family:Segoe UI,Arial,sans-serif'>
            <h2>Automação E2E executada após deploy</h2>
            <p><b>Status do job:</b> $(Agent.JobStatus)</p>
            <ul>
              <li><b>Resumo/Tests:</b> <a href='$testsTab'>$testsTab</a></li>
              <li><b>Job completo:</b> <a href='$buildUrl'>$buildUrl</a></li>
            </ul>
          </div>
          "@

          $secure = ConvertTo-SecureString "$(SmtpPass)" -AsPlainText -Force
          $cred = New-Object System.Management.Automation.PSCredential($user, $secure)

          Send-MailMessage `
            -From $from `
            -To '$(EmailTo)' `
            -Subject $subject `
            -Body $body `
            -BodyAsHtml `
            -SmtpServer '$(SmtpHost)' `
            -Port $(SmtpPort) `
            -UseSsl `
            -Credential $cred
