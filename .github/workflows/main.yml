name: E2E - Playwright + NUnit (Windows)

on:
  workflow_dispatch:
    inputs:
      app_url:
        description: "URL da aplicação alvo"
        required: false
        default: "https://portal.idsf.com.br/"
      env:
        description: "Ambiente (homolog/prod/local)"
        required: false
        default: "prod"
  push:
    branches: ["main"]
  repository_dispatch:
    types: [deployed]

concurrency:
  group: e2e-${{ github.ref }}
  cancel-in-progress: true

jobs:
  e2e:
    runs-on: windows-latest

    env:
      TEST_PROJECT: PortalIDSFTestes/PortalIDSFTestes.csproj   # <-- ajuste se necessário
      APP_URL: ${{ github.event.inputs.app_url || github.event.client_payload.app_url || 'https://portal.idsf.com.br/' }}
      ENVIRONMENT: ${{ github.event.inputs.env || github.event.client_payload.env || 'prod' }}
      PLAYWRIGHT_BROWSERS_PATH: C:\playwright-browsers

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 8 (com cache NuGet)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"
          cache: 'nuget'
          cache-dependency-path: |
            **/*.csproj
            **/packages.lock.json

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ${{ env.PLAYWRIGHT_BROWSERS_PATH }}
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/playwright.ps1') }}

      - name: Restore (só o projeto de testes)
        run: dotnet restore $env:TEST_PROJECT

      - name: Build (só o projeto de testes)
        run: dotnet build $env:TEST_PROJECT -c Release --no-restore

      - name: Install Playwright browsers
        shell: pwsh
        run: |
          $pw = Get-ChildItem -Recurse -Filter "playwright.ps1" | Select-Object -First 1
          if (-not $pw) { Write-Error "playwright.ps1 não encontrado (verifique Microsoft.Playwright no projeto)"; exit 1 }
          pwsh $pw.FullName install --with-deps

      - name: Run tests (gera allure-results)
        shell: pwsh
        run: |
          $env:APP_URL="${{ env.APP_URL }}"
          dotnet test $env:TEST_PROJECT -c Release --no-build --logger "trx;LogFileName=test-results.trx"
          # tenta localizar a pasta allure-results em qualquer lugar do repo
          $dir = Get-ChildItem -Path $PWD -Recurse -Directory -Filter "allure-results" | Select-Object -First 1
          if (-not $dir) { Write-Error "allure-results não encontrado. Confira Allure.NUnit + allureConfig.json."; exit 1 }
          "ALLURE_RESULTS_DIR=$($dir.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Host "Allure results em: $($dir.FullName)"

      - name: Generate Allure Report (HTML)
        uses: simple-elf/allure-report-action@v1.8
        with:
          results_dir: ${{ env.ALLURE_RESULTS_DIR }}
          report_dir: allure-report
        continue-on-error: true

      - name: Upload Allure Report (HTML)
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report

      - name: Upload Allure Results (raw)
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: ${{ env.ALLURE_RESULTS_DIR }}

      - name: Upload TRX
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-trx
          path: "**/test-results.trx"
